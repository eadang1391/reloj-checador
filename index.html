<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reloj Checador Pro</title>
    <!-- Librer√≠as de React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel para procesar el c√≥digo JSX en tiempo real -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDK (Versi√≥n de compatibilidad) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <!-- Tailwind CSS para el dise√±o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-stone-100">
    <div id="root"></div>

    <!-- El c√≥digo se incluye directamente aqu√≠ para evitar errores de carga de archivos (CORS) -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- CONFIGURACI√ìN DE FIREBASE (ASEG√öRATE DE PEGAR TUS DATOS AQU√ç) ---
       const firebaseConfig = {
  apiKey: "AIzaSyBBMYDOqzXp1DUQArqYGXgGPyRjoV5eEEQ",
  authDomain: "checador-escarola.firebaseapp.com",
  projectId: "checador-escarola",
  storageBucket: "checador-escarola.firebasestorage.app",
  messagingSenderId: "836776118383",
  appId: "1:836776118383:web:8d8ac6db5d4cc36f59659a"
};

        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('employee');
            const [employees, setEmployees] = useState([]);
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                // Autenticaci√≥n an√≥nima para seguridad b√°sica
                auth.signInAnonymously().catch(err => console.error("Error Auth:", err));
                const unsubscribeAuth = auth.onAuthStateChanged((u) => setUser(u));
                return () => unsubscribeAuth();
            }, []);

            useEffect(() => {
                if (!user) return;

                // Escuchar empleados
                const unsubEmp = db.collection('employees').orderBy('name').onSnapshot(snap => {
                    setEmployees(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    setLoading(false);
                }, err => console.error("Error Firestore Emp:", err));

                // Escuchar registros de tiempo
                const unsubLogs = db.collection('time_logs').orderBy('timestamp', 'desc').onSnapshot(snap => {
                    setLogs(snap.docs.map(d => ({ 
                        id: d.id, 
                        ...d.data(), 
                        dateObj: d.data().timestamp ? d.data().timestamp.toDate() : new Date() 
                    })));
                }, err => console.error("Error Firestore Logs:", err));

                return () => { unsubEmp(); unsubLogs(); };
            }, [user]);

            if (loading) return (
                <div className="flex flex-col items-center justify-center h-screen space-y-4">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-800"></div>
                    <p className="text-stone-600 font-medium">Iniciando Sistema...</p>
                </div>
            );

            return (
                <div className="min-h-screen">
                    <nav className="bg-green-950 text-white p-4 flex justify-between items-center shadow-xl border-b border-green-900">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                                <span className="font-bold">üïí</span>
                            </div>
                            <h1 className="text-xl font-bold tracking-tight italic">RELOJ <span className="text-green-400">CHECADOR</span></h1>
                        </div>
                        <button 
                            onClick={() => setView(view === 'employee' ? 'admin' : 'employee')} 
                            className="bg-green-800 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-bold transition-all shadow-inner border border-green-700"
                        >
                            {view === 'employee' ? '‚öôÔ∏è PANEL ADMIN' : 'üïí VOLVER AL RELOJ'}
                        </button>
                    </nav>

                    <div className="max-w-5xl mx-auto p-4 md:p-8">
                        {view === 'employee' ? (
                            <EmployeeTerminal employees={employees} db={db} />
                        ) : (
                            <AdminPanel employees={employees} logs={logs} db={db} setView={setView} />
                        )}
                    </div>
                </div>
            );
        }

        function EmployeeTerminal({ employees, db }) {
            const [selected, setSelected] = useState(null);
            const [pin, setPin] = useState('');
            const [status, setStatus] = useState(null);

            const handleLog = async (type) => {
                if (pin !== selected.pin) {
                    setStatus({ type: 'error', msg: 'PIN INCORRECTO' });
                    setPin('');
                    return;
                }
                try {
                    await db.collection('time_logs').add({
                        employeeId: selected.id,
                        employeeName: selected.name,
                        type: type,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setStatus({ type: 'success', msg: `¬°${type === 'IN' ? 'ENTRADA' : 'SALIDA'} REGISTRADA!` });
                    setTimeout(() => {
                        setSelected(null);
                        setPin('');
                        setStatus(null);
                    }, 2000);
                } catch (err) {
                    setStatus({ type: 'error', msg: 'ERROR DE CONEXI√ìN' });
                }
            };

            return (
                <div className="py-4">
                    {status && (
                        <div className={`mb-6 p-4 rounded-xl text-center font-bold shadow-lg animate-bounce ${status.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                            {status.msg}
                        </div>
                    )}

                    {!selected ? (
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                            {employees.length > 0 ? employees.map(e => (
                                <button 
                                    key={e.id} 
                                    onClick={() => setSelected(e)} 
                                    className="p-8 bg-white rounded-2xl shadow-sm border-b-4 border-stone-200 hover:border-green-600 hover:shadow-xl transition-all text-left group"
                                >
                                    <div className="text-xs uppercase tracking-widest text-stone-400 mb-1 group-hover:text-green-600">Empleado</div>
                                    <div className="text-xl font-black text-stone-800">{e.name}</div>
                                </button>
                            )) : (
                                <div className="col-span-full text-center py-20 text-stone-400 italic">
                                    No hay empleados registrados. Ve al Panel Admin.
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="max-w-md mx-auto bg-white p-10 rounded-3xl shadow-2xl border border-stone-100 text-center animate-fadeIn">
                            <h2 className="text-3xl font-black text-stone-900 mb-2">{selected.name}</h2>
                            <p className="text-stone-400 mb-8 uppercase tracking-tighter">Ingresa tu clave de acceso</p>
                            
                            <input 
                                type="password" 
                                value={pin} 
                                onChange={e => setPin(e.target.value)} 
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                className="w-full p-5 border-2 border-stone-100 rounded-2xl mb-8 text-center text-4xl font-mono tracking-[1em] focus:border-green-600 outline-none bg-stone-50"
                                maxLength={4}
                                autoFocus
                            />
                            
                            <div className="grid grid-cols-2 gap-4">
                                <button 
                                    onClick={() => handleLog('IN')} 
                                    className="bg-green-600 hover:bg-green-700 text-white p-6 rounded-2xl font-black shadow-lg shadow-green-100 transition-all flex flex-col items-center gap-2"
                                >
                                    <span>ENTRADA</span>
                                </button>
                                <button 
                                    onClick={() => handleLog('OUT')} 
                                    className="bg-red-700 hover:bg-red-800 text-white p-6 rounded-2xl font-black shadow-lg shadow-red-100 transition-all flex flex-col items-center gap-2"
                                >
                                    <span>SALIDA</span>
                                </button>
                            </div>
                            <button 
                                onClick={() => { setSelected(null); setPin(''); setStatus(null); }} 
                                className="mt-8 text-stone-400 hover:text-stone-800 font-bold uppercase text-xs"
                            >
                                ‚úï CANCELAR
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        function AdminPanel({ employees, logs, db, setView }) {
            const [name, setName] = useState('');
            const [pin, setPin] = useState('');

            const add = async (e) => {
                e.preventDefault();
                if(!name || !pin) return;
                await db.collection('employees').add({ 
                    name, 
                    pin,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                setName(''); setPin('');
            };

            return (
                <div className="space-y-8 pb-20">
                    <div className="flex flex-col md:flex-row justify-between items-end gap-4 border-b border-stone-200 pb-6">
                        <div>
                            <h2 className="text-4xl font-black text-stone-900">Panel de Control</h2>
                            <p className="text-stone-500 italic">Gesti√≥n de personal y asistencia diaria</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-1 space-y-6">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
                                <h3 className="font-black text-stone-800 mb-6 uppercase text-sm tracking-widest border-l-4 border-green-600 pl-3">Registrar Nuevo</h3>
                                <form onSubmit={add} className="space-y-4">
                                    <div>
                                        <label className="text-[10px] font-bold text-stone-400 uppercase ml-1">Nombre Completo</label>
                                        <input value={name} onChange={e => setName(e.target.value)} placeholder="Ej: Juan P√©rez" className="w-full border p-3 rounded-xl focus:ring-2 focus:ring-green-600 outline-none transition-all" required />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-stone-400 uppercase ml-1">PIN de Seguridad (4 d√≠gitos)</label>
                                        <input value={pin} onChange={e => setPin(e.target.value)} type="number" placeholder="1234" className="w-full border p-3 rounded-xl focus:ring-2 focus:ring-green-600 outline-none transition-all" required />
                                    </div>
                                    <button type="submit" className="w-full bg-stone-900 text-white p-4 rounded-xl font-bold hover:bg-stone-800 transition-all shadow-lg">GUARDAR EMPLEADO</button>
                                </form>
                            </div>
                        </div>

                        <div className="lg:col-span-2 space-y-6">
                            <div className="bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden">
                                <div className="p-4 bg-stone-50 border-b font-black text-xs text-stone-500 tracking-widest uppercase">Lista de Empleados</div>
                                <div className="divide-y divide-stone-100">
                                    {employees.map(e => (
                                        <div key={e.id} className="p-4 flex justify-between items-center hover:bg-stone-50 transition-colors">
                                            <div>
                                                <div className="font-black text-stone-800">{e.name}</div>
                                                <div className="text-xs text-stone-400">Acceso: <span className="font-mono bg-stone-100 px-1 rounded">{e.pin}</span></div>
                                            </div>
                                            <button 
                                                onClick={() => { if(confirm('¬øEliminar empleado?')) db.collection('employees').doc(e.id).delete() }} 
                                                className="p-2 text-stone-300 hover:text-red-600 transition-colors"
                                            >
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    ))}
                                    {employees.length === 0 && <div className="p-10 text-center text-stone-400 italic">No hay registros</div>}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
